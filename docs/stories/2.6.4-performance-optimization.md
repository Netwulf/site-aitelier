# Story 2.6.4 — Performance Optimization

**Epic:** 6 - Polish & Launch
**Priority:** P1
**Estimate:** 3-4 hours
**Status:** Ready
**Depends on:** All features implemented

---

## User Story

As a visitor, I want the site to load quickly and feel smooth so I can have a premium experience that matches the brand positioning.

---

## Acceptance Criteria

- [ ] Lighthouse Performance > 90
- [ ] Lighthouse Accessibility > 95
- [ ] LCP < 2.5s
- [ ] FID < 100ms
- [ ] CLS < 0.1
- [ ] All images optimized
- [ ] Code splitting implemented
- [ ] Fonts optimized

---

## Optimization Tasks

### 1. Image Optimization

```tsx
// Use next-gen formats and srcset

// Convert all images to WebP with fallback
// Use responsive images

<picture>
  <source
    srcSet="/assets/image.avif"
    type="image/avif"
  />
  <source
    srcSet="/assets/image.webp"
    type="image/webp"
  />
  <img
    src="/assets/image.jpg"
    alt=""
    loading="lazy"
    decoding="async"
    width={800}
    height={450}
  />
</picture>
```

### 2. Lazy Loading Components

```tsx
// src/App.tsx

import { lazy, Suspense } from 'react';

// Lazy load pages
const Campo = lazy(() => import('./pages/Campo'));
const Estudos = lazy(() => import('./pages/Estudos'));
const Archive = lazy(() => import('./pages/Archive'));

// In routes
<Suspense fallback={<PageLoader />}>
  <Routes>
    <Route path="/campo" element={<Campo />} />
    <Route path="/estudos" element={<Estudos />} />
    <Route path="/archive" element={<Archive />} />
  </Routes>
</Suspense>
```

### 3. Page Loader Component

```tsx
// src/components/PageLoader.tsx

export const PageLoader = () => {
  return (
    <div className="min-h-screen bg-brutal-black flex items-center justify-center">
      <div className="text-text-muted font-mono text-sm">
        Carregando...
      </div>
    </div>
  );
};
```

### 4. Font Optimization

```html
<!-- index.html -->

<!-- Preconnect to font origin -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<!-- Preload critical fonts -->
<link
  rel="preload"
  href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500&display=swap"
  as="style"
>

<!-- Load fonts with display=swap -->
<link
  href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Inter:wght@400;500&family=JetBrains+Mono:wght@400&display=swap"
  rel="stylesheet"
>
```

### 5. Critical CSS

```tsx
// Inline critical CSS in index.html for above-fold content

<style>
  /* Critical CSS for hero */
  .hero-critical {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #0a0a0a;
    color: #f5f5f0;
  }
</style>
```

### 6. Bundle Analysis

```bash
# Add to package.json scripts
"analyze": "vite-bundle-visualizer"

# Run to see bundle size
npm run analyze
```

### 7. Code Splitting for Heavy Components

```tsx
// Lazy load heavy components

const VisualArchiveGrid = lazy(() =>
  import('@/components/VisualArchiveGrid')
);

const Conselheiros = lazy(() =>
  import('@/components/Conselheiros')
);
```

### 8. Image Component with Optimization

```tsx
// src/components/OptimizedImage.tsx

interface OptimizedImageProps {
  src: string;
  alt: string;
  width: number;
  height: number;
  priority?: boolean;
  className?: string;
}

export const OptimizedImage = ({
  src,
  alt,
  width,
  height,
  priority = false,
  className,
}: OptimizedImageProps) => {
  // Generate WebP and AVIF variants
  const webpSrc = src.replace(/\.(jpg|png)$/, '.webp');
  const avifSrc = src.replace(/\.(jpg|png)$/, '.avif');

  return (
    <picture>
      <source srcSet={avifSrc} type="image/avif" />
      <source srcSet={webpSrc} type="image/webp" />
      <img
        src={src}
        alt={alt}
        width={width}
        height={height}
        loading={priority ? 'eager' : 'lazy'}
        decoding={priority ? 'sync' : 'async'}
        className={className}
      />
    </picture>
  );
};
```

### 9. Vite Config Optimization

```typescript
// vite.config.ts

import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor-react': ['react', 'react-dom', 'react-router-dom'],
          'vendor-animation': ['framer-motion'],
          'vendor-ui': ['@radix-ui/react-dialog', '@radix-ui/react-accordion'],
        },
      },
    },
    // Enable minification
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true,
      },
    },
  },
});
```

### 10. Service Worker (Optional)

```typescript
// For caching static assets
// Use vite-plugin-pwa if needed
```

---

## Lighthouse Audit Checklist

**Performance:**
- [ ] Images in next-gen formats
- [ ] Images properly sized
- [ ] Text compression enabled
- [ ] Efficient cache policy
- [ ] No render-blocking resources
- [ ] Reduced unused JavaScript

**Accessibility:**
- [ ] All images have alt text
- [ ] Color contrast sufficient
- [ ] Focus states visible
- [ ] Heading hierarchy correct
- [ ] Links have descriptive text
- [ ] Touch targets >= 48px

**Best Practices:**
- [ ] HTTPS
- [ ] No mixed content
- [ ] No deprecated APIs
- [ ] No browser errors

**SEO:**
- [ ] Meta description
- [ ] Crawlable links
- [ ] Valid robots.txt
- [ ] Valid sitemap

---

## Files to Create

- [ ] `src/components/PageLoader.tsx`
- [ ] `src/components/OptimizedImage.tsx`

## Files to Modify

- [ ] `vite.config.ts` — Build optimization
- [ ] `index.html` — Font preload, critical CSS
- [ ] `src/App.tsx` — Lazy loading

---

## Testing

- [ ] Run Lighthouse audit on all pages
- [ ] Test on slow 3G throttling
- [ ] Test on mobile devices
- [ ] Check bundle size (target < 200KB initial)
- [ ] Verify images load correctly
- [ ] No console errors in production build

---

## Performance Budget

| Metric | Target |
|--------|--------|
| Initial JS | < 200KB |
| Initial CSS | < 50KB |
| Total page weight | < 1MB |
| Time to Interactive | < 3s |
| First Contentful Paint | < 1.5s |
| Largest Contentful Paint | < 2.5s |
