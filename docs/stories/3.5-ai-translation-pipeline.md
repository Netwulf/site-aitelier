# Story 3.5: AI Translation Pipeline

**Epic:** AITELIER-3.0-I18N
**Status:** Draft
**Priority:** P1
**Estimate:** 3-4 hours
**Depends on:** 3.2

---

## Story

**As a** developer,
**I want** an automated translation script using AI,
**so that** I can keep English translations in sync with Portuguese content.

---

## Acceptance Criteria

1. Script translates PT-BR JSON files to EN-US
2. Maintains JSON structure and key names
3. Uses Gemini or OpenAI API for translation
4. Supports artistic/poetic tone guidelines
5. Only translates changed/new keys (diff detection)
6. npm script available (`npm run translate`)
7. Review mode available (output to review folder)
8. Handles nested JSON properly

---

## Tasks / Subtasks

- [ ] **Setup script environment** (AC: 6)
  - [ ] Create `scripts/translate.ts`
  - [ ] Add to package.json scripts
  - [ ] Configure TypeScript for scripts

- [ ] **Implement translation logic** (AC: 1, 2, 8)
  - [ ] Read PT-BR JSON files
  - [ ] Parse and flatten structure
  - [ ] Translate values (preserve keys)
  - [ ] Reconstruct nested structure
  - [ ] Write EN-US JSON files

- [ ] **Configure AI API** (AC: 3)
  - [ ] Setup Gemini API client
  - [ ] Alternative: OpenAI fallback
  - [ ] Handle API rate limits
  - [ ] Error handling and retries

- [ ] **Create translation prompt** (AC: 4)
  - [ ] Artistic/poetic guidelines
  - [ ] Brand voice consistency
  - [ ] Context preservation
  - [ ] "Futuro Ancestral" philosophy

- [ ] **Implement diff detection** (AC: 5)
  - [ ] Compare PT and EN JSONs
  - [ ] Find new/modified keys
  - [ ] Only translate differences
  - [ ] Log what was translated

- [ ] **Add review mode** (AC: 7)
  - [ ] `--review` flag
  - [ ] Output to `locales/review/` folder
  - [ ] Human can approve before merging
  - [ ] Merge script for approved translations

- [ ] **Documentation**
  - [ ] Usage instructions in README
  - [ ] API key setup guide
  - [ ] Translation guidelines reference

---

## Dev Notes

### Script Architecture

```
scripts/
├── translate.ts          # Main script
├── lib/
│   ├── ai-client.ts      # Gemini/OpenAI wrapper
│   ├── json-utils.ts     # JSON flatten/unflatten
│   └── diff.ts           # Change detection
└── prompts/
    └── translation.txt   # System prompt for AI
```

### Translation Script Implementation

```typescript
// scripts/translate.ts
import { GoogleGenerativeAI } from '@google/generative-ai';
import * as fs from 'fs';
import * as path from 'path';

const LOCALES_DIR = 'src/i18n/locales';
const SOURCE_LANG = 'pt-BR';
const TARGET_LANG = 'en-US';

interface TranslationOptions {
  review?: boolean;
  force?: boolean;
  namespace?: string;
}

async function translateFile(
  filename: string,
  genAI: GoogleGenerativeAI,
  options: TranslationOptions
) {
  const sourcePath = path.join(LOCALES_DIR, SOURCE_LANG, filename);
  const targetPath = path.join(
    LOCALES_DIR,
    options.review ? 'review' : TARGET_LANG,
    filename
  );

  const sourceContent = JSON.parse(fs.readFileSync(sourcePath, 'utf-8'));
  let targetContent = {};

  // Load existing translations if not forcing
  if (!options.force && fs.existsSync(targetPath)) {
    targetContent = JSON.parse(fs.readFileSync(targetPath, 'utf-8'));
  }

  // Find keys needing translation
  const toTranslate = findMissingKeys(sourceContent, targetContent);

  if (Object.keys(toTranslate).length === 0) {
    console.log(`✓ ${filename}: No new translations needed`);
    return;
  }

  console.log(`→ ${filename}: Translating ${Object.keys(toTranslate).length} keys...`);

  // Translate with AI
  const translated = await translateWithAI(genAI, toTranslate);

  // Merge with existing
  const merged = deepMerge(targetContent, translated);

  // Write output
  fs.mkdirSync(path.dirname(targetPath), { recursive: true });
  fs.writeFileSync(targetPath, JSON.stringify(merged, null, 2));

  console.log(`✓ ${filename}: Done`);
}

async function translateWithAI(
  genAI: GoogleGenerativeAI,
  content: Record<string, string>
): Promise<Record<string, string>> {
  const model = genAI.getGenerativeModel({ model: 'gemini-1.5-flash' });

  const prompt = `${TRANSLATION_PROMPT}

JSON to translate:
${JSON.stringify(content, null, 2)}

Respond with ONLY the translated JSON, no explanation.`;

  const result = await model.generateContent(prompt);
  const text = result.response.text();

  // Extract JSON from response
  const jsonMatch = text.match(/\{[\s\S]*\}/);
  if (!jsonMatch) throw new Error('No JSON in response');

  return JSON.parse(jsonMatch[0]);
}
```

### Translation Prompt

```typescript
const TRANSLATION_PROMPT = `You are translating content for AI.TELIER, an artistic AI studio.

BRAND VOICE:
- Philosophical and poetic
- "Futuro Ancestral" (Ancestral Future) philosophy
- Brutalist aesthetic - exposed, raw, honest
- Invitations, not demands
- Blend of ancient wisdom and future technology

TRANSLATION GUIDELINES:
1. Preserve poetic rhythm and flow
2. Adapt culturally, don't translate literally
3. Keep brand terms in Portuguese: "AI.TELIER", "Campo", "Futuro Ancestral"
4. Maintain the mystical-technical tone
5. Short sentences, powerful phrases
6. Avoid corporate/marketing speak

EXAMPLES:
PT: "A arte que ensinamos cria. A arte que criamos ensina."
EN: "The art we teach creates. The art we create teaches."

PT: "O futuro é ancestral."
EN: "The future is ancestral."

Translate Portuguese to English, preserving the artistic intent:`;
```

### Package.json Scripts

```json
{
  "scripts": {
    "translate": "tsx scripts/translate.ts",
    "translate:review": "tsx scripts/translate.ts --review",
    "translate:force": "tsx scripts/translate.ts --force",
    "translate:merge": "tsx scripts/merge-review.ts"
  }
}
```

### Diff Detection Logic

```typescript
function findMissingKeys(
  source: Record<string, any>,
  target: Record<string, any>,
  prefix = ''
): Record<string, string> {
  const missing: Record<string, string> = {};

  for (const [key, value] of Object.entries(source)) {
    const fullKey = prefix ? `${prefix}.${key}` : key;

    if (typeof value === 'object' && value !== null) {
      Object.assign(missing, findMissingKeys(value, target[key] || {}, fullKey));
    } else if (!(key in target) || target[key] !== value) {
      // New key or value changed
      missing[fullKey] = value;
    }
  }

  return missing;
}
```

### Environment Setup

```bash
# .env
GOOGLE_GENERATIVE_AI_KEY=your-api-key

# Or for OpenAI
OPENAI_API_KEY=your-api-key
```

### Usage Examples

```bash
# Translate all changed keys
npm run translate

# Force re-translate everything
npm run translate:force

# Output to review folder first
npm run translate:review

# Translate specific namespace
npm run translate -- --namespace=home
```

---

## Testing Checklist

- [ ] Script runs without errors
- [ ] JSON structure preserved
- [ ] Keys not translated (only values)
- [ ] Nested objects handled correctly
- [ ] Diff detection works (skips unchanged)
- [ ] Review mode outputs to correct folder
- [ ] API errors handled gracefully
- [ ] Rate limiting respected

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-02 | 1.0 | Story created | PO Agent |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_
